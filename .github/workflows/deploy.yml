name: Deploy to Vercel

on:
  push:
    branches: [master, staging-latest]

env:
  VERCEL_ORG_ID: team_ZULS7b0YtpzNC8sJCQFLnsaZ

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Vercel CLI
        run: npm i -g vercel

      - name: Set environment variables
        run: |
          if [ "${{ github.ref_name }}" = "master" ]; then
            echo "VERCEL_PROJECT_ID=prj_pajiiUCE7AxOqUm5SHy3ORGR6KJm" >> $GITHUB_ENV
            echo "VITE_API_URL=https://api.screna.ai/api/v1" >> $GITHUB_ENV
            echo "API_REWRITE_DEST=https://api.screna.ai/api/v1/:path*" >> $GITHUB_ENV
          else
            echo "VERCEL_PROJECT_ID=prj_aWjiRKUTjAffvtFGPrJJVrhHgGJx" >> $GITHUB_ENV
            echo "VITE_API_URL=https://api-staging.screna.ai/api/v1" >> $GITHUB_ENV
            echo "API_REWRITE_DEST=https://api-staging.screna.ai/api/v1/:path*" >> $GITHUB_ENV
          fi

      - name: Update vercel.json with correct API rewrite
        run: |
          cat > vercel.json << EOF
          {
            "rewrites": [
              {
                "source": "/api/v1/:path*",
                "destination": "${{ env.API_REWRITE_DEST }}"
              },
              {
                "source": "/(.*)",
                "destination": "/index.html"
              }
            ]
          }
          EOF

      - name: Pull Vercel environment
        run: vercel pull --yes --environment=production --token=${{ secrets.VERCEL_TOKEN }}

      - name: Build project
        run: vercel build --prod --token=${{ secrets.VERCEL_TOKEN }}

      - name: Deploy to Vercel
        run: vercel deploy --prebuilt --prod --token=${{ secrets.VERCEL_TOKEN }}
